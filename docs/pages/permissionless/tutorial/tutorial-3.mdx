import { GeneratePrivateKey } from "../../../components/generatePrivateKey"

# Tutorial 3 â€” Submit a user operation with an ERC-20 Paymaster

:::info
You can visit our [ERC-20 Paymaster overview page](/infra/paymaster/erc20-paymaster) to learn more about the design and architecture of our ERC-20 Paymaster, and the deployed smart contract addresses.
:::

In this tutorial, you will deploy an ERC-4337 smart contract wallet on Sepolia, and submit a user operation that pays for its gas fees with USDC using an ERC-20 Paymaster.

## Steps

::::steps

### Get a Pimlico API key

:::info
**The ERC-20 paymaster itself is completely permissionless, there is no requirement to use an API key for it**. We are using an API key in this tutorial to get access to the bundler to make the tutorial flow easier.
:::

To get started, please go to our [dashboard](https://dashboard.pimlico.io) and generate a Pimlico API key.

### Clone the Pimlico tutorial template repository

We have created a [Pimlico tutorial template repository](https://github.com/pimlicolabs/tutorial-template) that you can use to get started. It comes set up with Typescript, viem, and permissionless.js.

```bash
git clone https://github.com/pimlicolabs/tutorial-template.git pimlico-tutorial-3
cd pimlico-tutorial-3
```

Now, let's install the dependencies:

```bash
npm install
```

The main file we will be working with is `index.ts`. Let's run it to make sure everything is working:

```bash
npm start
```

If everything has been set up correctly, you should see `Hello world!` printed to the console.

### Create the public and bundler clients, and generate a private key

The public client will be responsible for querying the blockchain, while the bundler client will be responsible for submitting user operations for relaying.

Make sure to replace `YOUR_PIMLICO_API_KEY` in the code below with your actual Pimlico API key.

Let's open up `index.ts`, and add the following to the bottom:

```ts
// [!include ~/snippets/tutorial-3.ts:clients]
```

### Create the `SmartAccount` instance

For the purposes of this guide, we will be using [Safe](https://safe.global) accounts. This account is an ERC-4337 wallet controlled by a single EOA signer.

:::tip[Tip]
Want to learn more about using Safe accounts? Take a look at our [dedicated Safe guide](/permissionless/how-to/accounts/use-safe-account)
:::

To create the Safe account, we will use the `signerToSafeSmartAccount` utility function from permissionless.js. 

In addition, we will also specify a call that must be executed during the deployment of the Safe account with the `setupTransactions` option. Namely, we will approve unlimited USDC to the ERC-20 Paymaster to allow it to withdraw USDC from the Safe account when we use it.

Add the following to the bottom of `index.ts`:

```ts 
// [!include ~/snippets/tutorial-3.ts:smartAccount]
```

Since we will be looking to fund our account with USDC (which is what we will use to pay gas fees with), we need to know the address where our smart wallet will be deployed.

Let's run this code with `npm start`. You should see something like this:

```txt
Smart account address: https://sepolia.basescan.org/address/0xbAd38BdCf884ED92ab370f69C0CD0B7b8a1459A1
```

### Get Testnet USDC on Sepolia

Let's get some USDC on the Sepolia testnet to the counterfactual address of the wallet we will be deploying. This will be used to pay for the gas fees of the user operation we will be submitting.

The recommended way to do this is to use the [USDC faucet](https://usdcfaucet.com/), select 'Base Sepolia' and enter the counterfactual sender address you generated in the previous step.

### Verify you have USDC on the counterfactual sender address

To make sure you have USDC on the counterfactual sender address, let's add a check to the bottom of `index.ts`:

```ts 
// [!include ~/snippets/tutorial-3.ts:checkBalance]
```

If you run this code with `npm start`, you should not see any errors, and you should see the USDC balance of the counterfactual sender address printed to the console.

```txt
Smart account USDC balance: 10 USDC
```

### Create the smart account client

Now that we have a `SmartAccount` instance, we need to create a `SmartAccountClient` instance to make transact from it. `SmartAccountClient` is an almost drop-in replacement for a viem [`WalletClient`](https://viem.sh/docs/clients/wallet), but it also includes some additional functionality for interacting with smart accounts. 

We then specify the optional `sponsorUserOperation` middleware function. This function will set the ERC-20 Paymaster as the designated sponsor for the user operation, allowing the paymaster to pay for the gas fees of the user operation in exchange for USDC.

During the same middleware function, we will also call the the `estimateUserOperationGas` function to fill in the gas limits for the user operation.

Finally, we specify the `gasPrice` middleware function to fetch the gas price from the bundler that we will use to submit the user operation in the next step.

Add the following to the bottom of `index.ts`:

```typescript
// [!include ~/snippets/tutorial-3.ts:smartAccountClient]
```

### Send a transaction from the smart account, paying only with USDC for gas fees.

Finally, let's submit a transaction from the smart account. We will send a transaction to the `0xd8da6bf26964af9d7eed9e03e53415d37aa96045` (vitalik.eth) address with `0x1234` as example `callData`. We will also specify the gas price we want to use, which we fetched from the bundler in the previous step.

Underneath the hood, the `SmartAccountClient` will build a user operation with the designated ERC-20 Paymaster, sign it with the smart account's private key, and then submit it to the bundler. The bundler will then query for receipts until it sees the user operation included on-chain.

Add the following to the bottom of `index.ts`:

```typescript
// [!include ~/snippets/tutorial-3.ts:submit]
```

Let's run this code again with `npm start`. You should see the transaction hash bundling the user operation on-chain printed to the console.

```txt
User operation included: https://sepolia.basescan.org/tx/0xf8e4fc41a134fc9530a0c019167f9dc0981874b90187717605355bdcce8b2fb7
```

You can now view the transaction on the Base Sepolia testnet explorer. By sending this user operation, you have:
- Deployed the counterfactual smart account contract
- Had your smart account approve the ERC-20 Paymaster to spend USDC during deployment
- Had this newly-deployed smart account verify the private key's signature
- Made an ERC-20 Paymaster sponsor the user operation's gas fees by taking USDC from the smart account
- Executed a simple transaction to `vitalik.eth`'s address


If you visit the address of the `sender` account on the [Base Sepolia explorer](https://sepolia.basescan.org), you should also see that some of your USDC balance has been deducted!

That's it! Congratulations!

::::

### Combined code

If you want to see the complete code that combines all of the previous steps, we uploaded it to a [separate repository](https://github.com/pimlicolabs/tutorials). If you're looking to run it, remember to replace the API key with your own!